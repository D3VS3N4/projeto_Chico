<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #111;
      color: #0f0;
      font-size: 24px;
      padding: 40px;
    }
    .historico {
      margin-top: 20px;
      padding: 10px;
      border-top: 1px solid #0f0;
    }
    .historico-item {
      font-size: 18px;
      margin-bottom: 5px;
    }
    .toggle {
      cursor: pointer;
      color: #0f0;
      margin-top: 10px;
      text-decoration: underline;
    }
  </style>
</head>
<body> 
  <h1>Status ao vivo</h1>
  <table id="tabela-historico" style="border: 1px solid #0f0; width: 100%; color: #0f0; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Nº</th>
        <th>Nível</th>
        <th>Status</th>
        <th>Data e Hora</th>
      </tr>
    </thead>
    <tbody id="tabela-corpo">
      <tr><td colspan="4">Carregando histórico...</td></tr>
    </tbody>
  </table>
  
    <div class="toggle" onclick="toggleHistorico()">Ver histórico</div>
    <div id="historico" class="historico" style="display: none;">
      <div id="historico-lista">Carregando histórico...</div>
    </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function atualizarStatus(data) {
      document.getElementById("info").innerHTML = ` Nivel: ${data.nivel} <br>Status: ${data.status}`;
    }

    //Atualiza em tempo real
    socket.on("status_atualizado", (data) => {
      atualizarStatus(data);

      // Se o histórico estiver visível, atualiza ele também
      const historicoDiv = document.getElementById("historico");
      if (historicoDiv.style.display !== "none") {
        getHistorico();
      }
    });

    async function getHistorico() {
      try {
        const res = await fetch("/historico");
        const lista = await res.json();
        const corpoTabela = document.getElementById("tabela-corpo");// cria elementos <tr> e <td> para montar a tabela linha por linha.

        if (lista.length === 0) {
          corpoTabela.innerHTML = `<tr><td colspan="4">Nenhuma atualização ainda.</td></tr>`;
          return;
        }

        corpoTabela.innerHTML = ""; // limpa a tabela
        
        for (let i = 0; i < lista.length; i++) {
          const item = lista[i];
          const numero =lista.length - i;

          const linha = document.createElement("tr"); //Cria a nova tr(linha)

          linha.innerHTML = `
            <td>${numero}</td>
            <td>${item.nivel}</td>
            <td>${item.status}</td>
            <td>${item.timestamp}</td>
          `;

          corpoTabela.appendChild(linha);
        }

      } catch (error) {
       const corpoTabela = document.getElementById("tabela-corpo");
        corpoTabela.innerHTML = `<tr><td colspan="4">Erro ao carregar histórico.</td></tr>`;
        console.error("Erro ao buscar /historico:", error);
      }
    }
    function toggleHistorico() {
      const historicoDiv = document.getElementById("historico");
      const toggle = document.querySelector(".toggle");

      if (historicoDiv.style.display === "none") {
        historicoDiv.style.display = "block";
        toggle.innerText = "Ocultar histórico";
        getHistorico(); // carrega só quando abre
      } else {
        historicoDiv.style.display = "none";
        toggle.innerText = "Ver histórico";
      }
    }

    fetch("/status")
      .then(res => res.json())
      .then(data => atualizarStatus(data));
  </script>
</body>
</html>