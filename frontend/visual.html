<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #111;
      color: #0f0;
      font-size: 24px;
      padding: 40px;
    }
    .historico {
      margin-top: 20px;
      padding: 10px;
      border-top: 1px solid #0f0;
    }
    .historico-item {
      font-size: 18px;
      margin-bottom: 5px;
    }
    .toggle {
      cursor: pointer;
      color: #0f0;
      margin-top: 10px;
      text-decoration: underline;
    }
  </style>
</head>
<body> 
  <h2>Histórico</h2>
  <table class="tabela-historico" id="tabela-status">
    <thead>
      <tr>
        <th>Nº</th>
        <th>Nível</th>
        <th>Status</th>
        <th>Data e Hora</th>
      </tr>
    </thead>
    <tbody id="corpo-tabela">
      <tr><td colspan="4">Carregando histórico...</td></tr>
    </tbody>
  </table>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function atualizarStatus(data) {
      const tabela = document.getElementById("corpo-tabela");

      // Remove a primeira linha antiga de status atual (se houver)
      const linhaStatusAntigo = document.getElementById("status-atual-linha");
      if (linhaStatusAntigo) linhaStatusAntigo.remove();

      // Cria nova linha de status atual
      const linha = document.createElement("tr");
      linha.id = "status-atual-linha";
      linha.style.backgroundColor = "#111"; // destaque

      linha.innerHTML = `
        <td>Atual</td>
        <td>${data.nivel}</td>
        <td>${data.status}</td>
        <td>${data.timestamp}</td>
      `;

      // Insere no início do tbody
      tabela.insertBefore(linha, tabela.firstChild);
    }

    //Atualiza em tempo real
    socket.on("status_atualizado", (data) => {
      atualizarStatus(data);
      getHistorico();
    });

    async function getHistorico() {
      try {
        const res = await fetch("/historico");
        const lista = await res.json();
        const tabela = document.getElementById("corpo-tabela");// cria elementos <tr> e <td> para montar a tabela linha por linha.

        // Remove todas as linhas exceto a primeira (status atual)
        const linhas = Array.from(tabela.querySelectorAll("tr"));
        linhas.forEach((linha, index) => {
          if (index !== 0 && linha.id !== "status-atual-linha") {
            linha.remove();
          }
        });

        if (lista.length === 0) {
          const linha = document.createElement("tr");
          linha.innerHTML = `<td colspan="4">Nenhuma atualização ainda.</td>`;
          tabela.appendChild(linha);
          return;
        }

        // Filtra lista para remover itens padrão (exemplo: nível 0 e status OK)
        const listaFiltrada = lista.filter(item => !(item.nivel === 0 && item.status === "OK"));

        for (let i = 0; i < listaFiltrada.length; i++) {
          const item = lista[i];
          const numero =lista.length - i;

          const linha = document.createElement("tr"); //Cria a nova tr(linha)

          linha.innerHTML = `
            <td>${numero}</td>
            <td>${item.nivel}</td>
            <td>${item.status}</td>
            <td>${item.timestamp}</td>
          `;

          tabela.appendChild(linha);
        }

      } catch (error) {
       console.error("Erro ao carregar histórico:", error);
      }
    }

    fetch("/status")
      .then(res => res.json())
      .then(data => atualizarStatus(data));
      
    getHistorico();
  </script>
</body>
</html>